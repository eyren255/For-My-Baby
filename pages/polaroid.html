<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Polaroid Wall Â· For My Baby</title>
        <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;500;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="../styles.css" />
        <link rel="manifest" href="../site.webmanifest" />
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
        <style>
            .board {
                min-height: 50vh;
                position: relative;
                background: #fff8fb;
                border: 1px dashed var(--border);
                border-radius: 14px;
                padding: 10px;
            }
            .pol {
                position: absolute;
                width: 160px;
                user-select: none;
                cursor: grab;
                touch-action: none;
                background: #fff;
                padding: 8px 8px 14px;
                border-radius: 8px;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
                will-change: left, top;
            }
            .pol img {
                width: 100%;
                display: block;
                border-radius: 6px;
            }
            .pol .cap {
                font-size: 12px;
                color: var(--muted);
                text-align: center;
                margin-top: 6px;
            }
            .controls {
                display: flex;
                gap: 8px;
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <header class="site-header">
            <div class="container row between center">
                <a class="brand" href="../index.html">For My Baby</a>
                <nav class="nav">
                    <a href="./quiz.html">Love Quiz</a>
                    <a href="./timeline.html">Timeline</a>
                    <a href="./polaroid.html" aria-current="page">Polaroid Wall</a>
                    <a href="./tictactoe.html">Ticâ€‘tacâ€‘toe</a>
                </nav>
            </div>
        </header>
        <main class="container site-grid">
            <section class="section card span-2">
                <h1 class="section-title">ðŸ“· Polaroid Wall</h1>
                <div
                    class="controls"
                    style="display: flex; gap: 8px; align-items: center; margin: 8px 0 10px 0"
                >
                    <input
                        id="room"
                        class="chip"
                        placeholder="Shared code (optional)"
                        aria-label="Shared code"
                    />
                    <button id="setRoom" class="chip">Set code</button>
                    <span class="muted" style="font-size: 12px">
                        Use the same code on other devices to sync.
                    </span>
                </div>
                <div class="controls">
                    <input id="file" type="file" accept="image/*" />
                    <input id="cap" class="chip" placeholder="Caption" />
                    <button id="add" class="chip">Add</button>
                    <button id="clear" class="chip">Clear wall</button>
                </div>
                <div id="board" class="board"></div>
            </section>
        </main>
        <footer class="site-footer">
            <div class="container center muted">
                Made with ðŸ’• Â· Â©
                <span id="year"></span>
            </div>
        </footer>
        <script>
            document.getElementById("year").textContent = new Date().getFullYear();
            const board = document.getElementById("board");

            // Firebase init
            const firebaseConfig = {
                apiKey: "AIzaSyBVVu_oIEsys6ZGluNw13tGfGiwNLhIiuA",
                authDomain: "baby-a2b63.firebaseapp.com",
                projectId: "baby-a2b63",
                storageBucket: "baby-a2b63.appspot.com",
                messagingSenderId: "177238221787",
                appId: "1:177238221787:web:b3e01b5de50f1da7347dfe",
                measurementId: "G-TJ3DMJVFG9"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Shared code helpers
            const ROOM_KEY = "shareRoom";
            function getRoom() {
                return (localStorage.getItem(ROOM_KEY) || "").trim();
            }
            function setRoom(v) {
                localStorage.setItem(ROOM_KEY, (v || "").trim());
            }
            document.getElementById("setRoom").addEventListener("click", () => {
                setRoom(document.getElementById("room").value);
                location.reload();
            });
            document.getElementById("room").value = getRoom();

            function renderDocs(snap) {
                board.innerHTML = "";
                snap.forEach((doc) => {
                    const p = doc.data();
                    const id = doc.id;
                    const d = document.createElement("div");
                    d.className = "pol";
                    d.style.left = (p.x || 10) + "px";
                    d.style.top = (p.y || 10) + "px";
                    d.style.transform = `rotate(${p.r || 0}deg)`;
                    d.innerHTML = `<img src="${p.src}" alt="photo"/><div class='cap'>${
                        p.cap || ""
                    }</div>`;
                    board.appendChild(d);
                    drag(d, (x, y) => {
                        db.collection("polaroids")
                            .doc(id)
                            .update({ x, y })
                            .catch(() => {});
                    });
                    d.addEventListener("dblclick", () => {
                        db.collection("polaroids")
                            .doc(id)
                            .delete()
                            .catch(() => {});
                    });
                });
            }
            function drag(el, onmove) {
                let sx, sy, ox, oy, lastX, lastY, pointerId;
                el.addEventListener("pointerdown", (e) => {
                    e.preventDefault();
                    pointerId = e.pointerId;
                    el.setPointerCapture(pointerId);
                    sx = e.clientX;
                    sy = e.clientY;
                    const rect = el.getBoundingClientRect();
                    const b = board.getBoundingClientRect();
                    ox = rect.left - b.left;
                    oy = rect.top - b.top;
                    el.style.cursor = "grabbing";
                });
                el.addEventListener("pointermove", (e) => {
                    if (sx == null) return;
                    const b = board.getBoundingClientRect();
                    let nx = ox + (e.clientX - sx);
                    let ny = oy + (e.clientY - sy);
                    nx = Math.max(0, Math.min(nx, b.width - el.offsetWidth));
                    ny = Math.max(0, Math.min(ny, b.height - el.offsetHeight));
                    el.style.left = nx + "px";
                    el.style.top = ny + "px";
                    lastX = nx;
                    lastY = ny;
                });
                const end = () => {
                    if (pointerId != null) {
                        try {
                            el.releasePointerCapture(pointerId);
                        } catch (_) {}
                    }
                    const fx = lastX != null ? lastX : ox;
                    const fy = lastY != null ? lastY : oy;
                    if (typeof onmove === "function") onmove(fx, fy);
                    sx = sy = lastX = lastY = pointerId = null;
                    el.style.cursor = "grab";
                };
                el.addEventListener("pointerup", end);
                el.addEventListener("pointercancel", end);
            }
            auth.signInAnonymously().then(() => {
                const uid = auth.currentUser.uid;
                const room = getRoom();
                // realtime
                let q = db.collection("polaroids");
                q = room ? q.where("room", "==", room) : q.where("user", "==", uid);
                q.onSnapshot(renderDocs);

                // add
                document.getElementById("add").addEventListener("click", () => {
                    const file = document.getElementById("file").files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                        db.collection("polaroids").add({
                            user: uid,
                            room: getRoom() || null,
                            src: reader.result,
                            cap: document.getElementById("cap").value,
                            x: 10,
                            y: 10,
                            r: (Math.random() * 10 - 5).toFixed(1),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    };
                    reader.readAsDataURL(file);
                });

                // clear
                document.getElementById("clear").addEventListener("click", async () => {
                    if (!confirm("Clear all photos?")) return;
                    const room = getRoom();
                    let q = db.collection("polaroids");
                    q = room ? q.where("room", "==", room) : q.where("user", "==", uid);
                    const snap = await q.get();
                    const batch = db.batch();
                    snap.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                });
            });
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker.register("../sw.js").catch(() => {});
                });
            }
        </script>
    </body>
</html>
